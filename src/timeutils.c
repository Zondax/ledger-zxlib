/*******************************************************************************
*   (c) 2018 Zondax GmbH
*
*  Licensed under the Apache License, Version 2.0 (the "License");
*  you may not use this file except in compliance with the License.
*  You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
*  Unless required by applicable law or agreed to in writing, software
*  distributed under the License is distributed on an "AS IS" BASIS,
*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
*  See the License for the specific language governing permissions and
*  limitations under the License.
********************************************************************************/
#include "zxmacros.h"
#include "timeutils.h"

#ifdef __cplusplus
extern "C" {
#endif

#include <stdint.h>
#include <stddef.h>

const uint8_t monthDays[] = {
        31,
        28,
        31,
        30,
        31,
        30,
        31,
        31,
        30,
        31,
        30,
        31
};

// This table can be generated using scripts/yearLookup.py. It covers up to year 2600
const uint32_t yearLookup[] = {
        0,
        365,
        730,
        1096,
        1461,
        1826,
        2191,
        2557,
        2922,
        3287,
        3652,
        4018,
        4383,
        4748,
        5113,
        5479,
        5844,
        6209,
        6574,
        6940,
        7305,
        7670,
        8035,
        8401,
        8766,
        9131,
        9496,
        9862,
        10227,
        10592,
        10957,
        11323,
        11688,
        12053,
        12418,
        12784,
        13149,
        13514,
        13879,
        14245,
        14610,
        14975,
        15340,
        15706,
        16071,
        16436,
        16801,
        17167,
        17532,
        17897,
        18262,
        18628,
        18993,
        19358,
        19723,
        20089,
        20454,
        20819,
        21184,
        21550,
        21915,
        22280,
        22645,
        23011,
        23376,
        23741,
        24106,
        24472,
        24837,
        25202,
        25567,
        25933,
        26298,
        26663,
        27028,
        27394,
        27759,
        28124,
        28489,
        28855,
        29220,
        29585,
        29950,
        30316,
        30681,
        31046,
        31411,
        31777,
        32142,
        32507,
        32872,
        33238,
        33603,
        33968,
        34333,
        34699,
        35064,
        35429,
        35794,
        36160,
        36525,
        36890,
        37255,
        37621,
        37986,
        38351,
        38716,
        39082,
        39447,
        39812,
        40177,
        40543,
        40908,
        41273,
        41638,
        42004,
        42369,
        42734,
        43099,
        43465,
        43830,
        44195,
        44560,
        44926,
        45291,
        45656,
        46021,
        46387,
        46752,
        47117,
        47482,
        47847,
        48212,
        48577,
        48942,
        49308,
        49673,
        50038,
        50403,
        50769,
        51134,
        51499,
        51864,
        52230,
        52595,
        52960,
        53325,
        53691,
        54056,
        54421,
        54786,
        55152,
        55517,
        55882,
        56247,
        56613,
        56978,
        57343,
        57708,
        58074,
        58439,
        58804,
        59169,
        59535,
        59900,
        60265,
        60630,
        60996,
        61361,
        61726,
        62091,
        62457,
        62822,
        63187,
        63552,
        63918,
        64283,
        64648,
        65013,
        65379,
        65744,
        66109,
        66474,
        66840,
        67205,
        67570,
        67935,
        68301,
        68666,
        69031,
        69396,
        69762,
        70127,
        70492,
        70857,
        71223,
        71588,
        71953,
        72318,
        72684,
        73049,
        73414,
        73779,
        74145,
        74510,
        74875,
        75240,
        75606,
        75971,
        76336,
        76701,
        77067,
        77432,
        77797,
        78162,
        78528,
        78893,
        79258,
        79623,
        79989,
        80354,
        80719,
        81084,
        81450,
        81815,
        82180,
        82545,
        82911,
        83276,
        83641,
        84006,
        84371,
        84736,
        85101,
        85466,
        85832,
        86197,
        86562,
        86927,
        87293,
        87658,
        88023,
        88388,
        88754,
        89119,
        89484,
        89849,
        90215,
        90580,
        90945,
        91310,
        91676,
        92041,
        92406,
        92771,
        93137,
        93502,
        93867,
        94232,
        94598,
        94963,
        95328,
        95693,
        96059,
        96424,
        96789,
        97154,
        97520,
        97885,
        98250,
        98615,
        98981,
        99346,
        99711,
        100076,
        100442,
        100807,
        101172,
        101537,
        101903,
        102268,
        102633,
        102998,
        103364,
        103729,
        104094,
        104459,
        104825,
        105190,
        105555,
        105920,
        106286,
        106651,
        107016,
        107381,
        107747,
        108112,
        108477,
        108842,
        109208,
        109573,
        109938,
        110303,
        110669,
        111034,
        111399,
        111764,
        112130,
        112495,
        112860,
        113225,
        113591,
        113956,
        114321,
        114686,
        115052,
        115417,
        115782,
        116147,
        116513,
        116878,
        117243,
        117608,
        117974,
        118339,
        118704,
        119069,
        119435,
        119800,
        120165,
        120530,
        120895,
        121260,
        121625,
        121990,
        122356,
        122721,
        123086,
        123451,
        123817,
        124182,
        124547,
        124912,
        125278,
        125643,
        126008,
        126373,
        126739,
        127104,
        127469,
        127834,
        128200,
        128565,
        128930,
        129295,
        129661,
        130026,
        130391,
        130756,
        131122,
        131487,
        131852,
        132217,
        132583,
        132948,
        133313,
        133678,
        134044,
        134409,
        134774,
        135139,
        135505,
        135870,
        136235,
        136600,
        136966,
        137331,
        137696,
        138061,
        138427,
        138792,
        139157,
        139522,
        139888,
        140253,
        140618,
        140983,
        141349,
        141714,
        142079,
        142444,
        142810,
        143175,
        143540,
        143905,
        144271,
        144636,
        145001,
        145366,
        145732,
        146097,
        146462,
        146827,
        147193,
        147558,
        147923,
        148288,
        148654,
        149019,
        149384,
        149749,
        150115,
        150480,
        150845,
        151210,
        151576,
        151941,
        152306,
        152671,
        153037,
        153402,
        153767,
        154132,
        154498,
        154863,
        155228,
        155593,
        155959,
        156324,
        156689,
        157054,
        157420,
        157785,
        158150,
        158515,
        158881,
        159246,
        159611,
        159976,
        160342,
        160707,
        161072,
        161437,
        161803,
        162168,
        162533,
        162898,
        163264,
        163629,
        163994,
        164359,
        164725,
        165090,
        165455,
        165820,
        166186,
        166551,
        166916,
        167281,
        167647,
        168012,
        168377,
        168742,
        169108,
        169473,
        169838,
        170203,
        170569,
        170934,
        171299,
        171664,
        172030,
        172395,
        172760,
        173125,
        173491,
        173856,
        174221,
        174586,
        174952,
        175317,
        175682,
        176047,
        176413,
        176778,
        177143,
        177508,
        177874,
        178239,
        178604,
        178969,
        179335,
        179700,
        180065,
        180430,
        180796,
        181161,
        181526,
        181891,
        182257,
        182622,
        182987,
        183352,
        183718,
        184083,
        184448,
        184813,
        185179,
        185544,
        185909,
        186274,
        186640,
        187005,
        187370,
        187735,
        188101,
        188466,
        188831,
        189196,
        189562,
        189927,
        190292,
        190657,
        191023,
        191388,
        191753,
        192118,
        192484,
        192849,
        193214,
        193579,
        193944,
        194309,
        194674,
        195039,
        195405,
        195770,
        196135,
        196500,
        196866,
        197231,
        197596,
        197961,
        198327,
        198692,
        199057,
        199422,
        199788,
        200153,
        200518,
        200883,
        201249,
        201614,
        201979,
        202344,
        202710,
        203075,
        203440,
        203805,
        204171,
        204536,
        204901,
        205266,
        205632,
        205997,
        206362,
        206727,
        207093,
        207458,
        207823,
        208188,
        208554,
        208919,
        209284,
        209649,
        210015,
        210380,
        210745,
        211110,
        211476,
        211841,
        212206,
        212571,
        212937,
        213302,
        213667,
        214032,
        214398,
        214763,
        215128,
        215493,
        215859,
        216224,
        216589,
        216954,
        217320,
        217685,
        218050,
        218415,
        218781,
        219146,
        219511,
        219876,
        220242,
        220607,
        220972,
        221337,
        221703,
        222068,
        222433,
        222798,
        223164,
        223529,
        223894,
        224259,
        224625,
        224990,
        225355,
        225720,
        226086,
        226451,
        226816,
        227181,
        227547,
        227912,
        228277,
        228642,
        229008,
        229373,
        229738,
        230103
};

// ARM does not implement gmtime. This is a simple alternative implementation
// based on section 4.16
// https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html
zxerr_t extractTime(uint64_t time, timedata_t *date) {
    if (date == NULL) {
        return zxerr_no_data;
    }
    MEMZERO(date, sizeof(timedata_t));

    date->tm_sec = (uint8_t) (time % 60);
    time -= date->tm_sec;
    time /= 60;

    date->tm_min = (uint8_t) (time % 60);
    time -= date->tm_min;
    time /= 60;

    date->tm_hour = (uint8_t) (time % 24);
    time -= date->tm_hour;
    time /= 24;

    // Look up tm_year
    date->tm_year = 0;
    const uint16_t yearLookupSize = sizeof(yearLookup)/sizeof(yearLookup[0]);
    while (date->tm_year < yearLookupSize && yearLookup[date->tm_year] <= time) {
        date->tm_year++;
    }


    if (date->tm_year == 0 || date->tm_year == yearLookupSize) {
        return zxerr_out_of_bounds;
    }
    date->tm_year--;

    date->tm_day = (uint16_t) (time - yearLookup[date->tm_year] + 1);
    date->tm_year = (uint16_t) (1970 + date->tm_year);

    // Get day/month
    uint8_t leap = (uint8_t) (date->tm_year % 4 == 0 && (date->tm_year % 100 != 0 || date->tm_year % 400 == 0) ? 1 : 0);

    for (date->tm_mon = 0; date->tm_mon < 12; date->tm_mon++) {
        uint8_t tmp = monthDays[date->tm_mon];
        tmp += (date->tm_mon == 1 ? leap : 0);
        if (date->tm_day <= tmp) {
            break;
        }
        date->tm_day -= tmp;
    }
    date->tm_mon++;
    date->monthName = getMonth(date->tm_mon);

    return zxerr_ok;
}

zxerr_t decodeTime(timedata_t* td, uint64_t t) {
    return extractTime(t, td);
}

zxerr_t printTime(char *out, uint16_t outLen, uint64_t t) {
    timedata_t date;
    CHECK_ZXERR(extractTime(t, &date))

    // YYYYmmdd HH:MM:SS
    snprintf(out, outLen, "%02d%s%04d %02d:%02d:%02dUTC",
             date.tm_day,
             date.monthName,
             date.tm_year,
             date.tm_hour, date.tm_min, date.tm_sec
    );

    return zxerr_ok;
}

zxerr_t printTimeSpecialFormat(char *out, uint16_t outLen, uint64_t t) {
    timedata_t date;
    CHECK_ZXERR(extractTime(t, &date))

    // YYYYmmdd HH:MM:SS
    snprintf(out, outLen, "%d-%02d-%02dT%02d:%02d:%02dZ",
             date.tm_year,
             date.tm_mon,
             date.tm_day,
             date.tm_hour, date.tm_min, date.tm_sec
    );

    return zxerr_ok;
}


#ifdef __cplusplus
}
#endif
